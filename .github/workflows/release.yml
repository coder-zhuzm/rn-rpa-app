# ğŸš€ RPA App å‘å¸ƒå·¥ä½œæµ
# ä»…åœ¨æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼Œè‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ APK

name: ğŸš€ å‘å¸ƒ RPA App

# è§¦å‘æ¡ä»¶ï¼šä»…æ ‡ç­¾æ¨é€
on:
  push:
    tags: [ 'v*' ]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v0.1.0)'
        required: true
        type: string

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '33'

jobs:
  # æ„å»º APK
  build:
    name: ğŸ”¨ æ„å»º APK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build-type: [debug, release]
    
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: â˜• è®¾ç½® JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ¤– è®¾ç½® Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ“¦ ç¼“å­˜ Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            auto-rpa-app/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('auto-rpa-app/android/**/*.gradle*', 'auto-rpa-app/android/**/gradle-wrapper.properties') }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: auto-rpa-app
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci || npm install
          else
            npm install
          fi

      - name: ğŸ”¨ æ„å»º Android APK (${{ matrix.build-type }})
        working-directory: auto-rpa-app/android
        run: |
          export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=512m"
          
          if [ "${{ matrix.build-type }}" = "release" ]; then
            ./gradlew assembleRelease --no-daemon --stacktrace
          else
            ./gradlew assembleDebug --no-daemon --stacktrace
          fi

      - name: ğŸ“¤ ä¸Šä¼  APK
        uses: actions/upload-artifact@v4
        with:
          name: rpa-app-${{ matrix.build-type }}
          path: auto-rpa-app/android/app/build/outputs/apk/**/*.apk
          retention-days: 30

  # å‘å¸ƒåˆ° GitHub Releases
  release:
    name: ğŸ·ï¸ åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [build]
    
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸ“‹ å‡†å¤‡å‘å¸ƒä¿¡æ¯
        id: release_info
        run: |
          # è·å–æ ‡ç­¾å
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ inputs.tag_name }}"
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=RPA App $TAG_NAME" >> $GITHUB_OUTPUT
          
          # è·å–æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: ${{ steps.release_info.outputs.release_name }}
          files: |
            ./artifacts/**/*.apk
          body: |
            ## ğŸ¤– RPA App å‘å¸ƒ ${{ steps.release_info.outputs.tag_name }}

            ### ğŸ“± APK ä¸‹è½½
            - **app-debug.apk**: å¼€å‘æµ‹è¯•ç‰ˆæœ¬ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯
            - **app-release.apk**: ç”Ÿäº§å‘å¸ƒç‰ˆæœ¬ï¼Œç»è¿‡ä¼˜åŒ–å’Œæ··æ·†

            ### ğŸ”„ æ›´æ–°å†…å®¹
            ${{ steps.release_info.outputs.commit_message }}

            ### ğŸ“Š æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.release_info.outputs.tag_name }}
            - **æäº¤**: ${{ github.sha }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æ„å»ºè€…**: GitHub Actions

            ### ğŸ“‹ å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”çš„ APK æ–‡ä»¶
            2. åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
            3. å®‰è£… APK æ–‡ä»¶

            ---
            **æ³¨æ„**: Release ç‰ˆæœ¬å·²ç»è¿‡ä»£ç æ··æ·†å’Œä¼˜åŒ–ï¼Œæ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨
          draft: false
          prerelease: true
          generate_release_notes: true

      - name: ğŸ“Š å‘å¸ƒå®Œæˆ
        run: |
          echo "ğŸ‰ å‘å¸ƒå®Œæˆ!"
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.release_info.outputs.tag_name }}"
          echo "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.tag_name }}" 