# ğŸ¤– RPA App CI/CD Pipeline
# è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„GitHub Actionså­¦ä¹ ç¤ºä¾‹
# åŒ…å«ä»£ç æ£€æŸ¥ã€æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒç­‰å®Œæ•´æµç¨‹

name: ğŸš€ RPA App CI/CD

# è§¦å‘æ¡ä»¶ - ä»€ä¹ˆæ—¶å€™è¿è¡Œè¿™ä¸ªAction
on:
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, develop ]
  # åˆ›å»ºPull Requestæ—¶è§¦å‘
  pull_request:
    branches: [ main ]
  # æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨GitHubç•Œé¢å¯ä»¥æ‰‹åŠ¨è¿è¡Œï¼‰
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡ - æ•´ä¸ªworkflowéƒ½å¯ä»¥ä½¿ç”¨
env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'  # æ›´æ–°åˆ°JDK 17ï¼ŒAndroid SDKå·¥å…·è¦æ±‚
  ANDROID_API_LEVEL: '33'

# ä»»åŠ¡å®šä¹‰
jobs:
  # ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼šä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„gitå†å²ï¼Œç”¨äºä»£ç åˆ†æ
          fetch-depth: 0

      # Step 2: è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Step 2.5: æ‰‹åŠ¨ç¼“å­˜npmä¾èµ–
      - name: ğŸ“¦ ç¼“å­˜ npm ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('auto-rpa-app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Step 3: æ£€æŸ¥æ–‡ä»¶å’Œå®‰è£…ä¾èµ–
      - name: ğŸ” æ£€æŸ¥é¡¹ç›®æ–‡ä»¶
        working-directory: auto-rpa-app
        run: |
          echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸ“‹ æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo ""
          echo "ğŸ” æ£€æŸ¥å…³é”®æ–‡ä»¶:"
          if [ -f "package.json" ]; then
            echo "âœ… package.json å­˜åœ¨"
            cat package.json | jq '.name, .version'
          else
            echo "âŒ package.json ä¸å­˜åœ¨"
          fi
          
          if [ -f "package-lock.json" ]; then
            echo "âœ… package-lock.json å­˜åœ¨"
            echo "ğŸ“Š å¤§å°: $(ls -lh package-lock.json | awk '{print $5}')"
          else
            echo "âŒ package-lock.json ä¸å­˜åœ¨"
            echo "ğŸ”§ å°†ä½¿ç”¨ npm install ä»£æ›¿ npm ci"
          fi

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: auto-rpa-app
        run: |
          echo "ğŸ“¥ å®‰è£…npmä¾èµ–..."
          if [ -f "package-lock.json" ]; then
            echo "ğŸ”’ å°è¯•ä½¿ç”¨ npm ci (é”å®šç‰ˆæœ¬)"
            if npm ci --prefer-offline --no-audit; then
              echo "âœ… npm ci æˆåŠŸ"
            else
              echo "âš ï¸ npm ci å¤±è´¥ï¼Œå¯èƒ½æ˜¯é”å®šæ–‡ä»¶ä¸åŒæ­¥"
              echo "ğŸ”„ åˆ é™¤é”å®šæ–‡ä»¶å¹¶é‡æ–°å®‰è£…..."
              rm package-lock.json
              npm install --prefer-offline --no-audit
              echo "âœ… é‡æ–°ç”Ÿæˆé”å®šæ–‡ä»¶å®Œæˆ"
            fi
          else
            echo "ğŸ†• ä½¿ç”¨ npm install (ç”Ÿæˆé”å®šæ–‡ä»¶)"
            npm install --prefer-offline --no-audit
          fi

      # Step 4: ä»£ç æ ¼å¼æ£€æŸ¥
      - name: ğŸ¨ ä»£ç æ ¼å¼æ£€æŸ¥
        working-directory: auto-rpa-app
        run: |
          echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
          npm run format:check || {
            echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
            echo "ğŸ’¡ è¿è¡Œ 'npm run format' ä¿®å¤æ ¼å¼é—®é¢˜"
            exit 1
          }

      # Step 5: ESLintæ£€æŸ¥
      - name: ğŸ” ESLint ä»£ç æ£€æŸ¥
        working-directory: auto-rpa-app
        continue-on-error: true
        run: |
          echo "ğŸ” è¿è¡ŒESLintæ£€æŸ¥..."
          npm run lint || {
            echo "âš ï¸ ESLintæ£€æŸ¥å‘ç°é—®é¢˜"
            echo "ğŸ’¡ è¿è¡Œ 'npm run lint:fix' å°è¯•è‡ªåŠ¨ä¿®å¤"
            echo "ğŸ“‹ è¿™ä¸ä¼šé˜»æ­¢æ„å»ºç»§ç»­è¿›è¡Œ"
          }

      # Step 6: TypeScriptç±»å‹æ£€æŸ¥
      - name: ğŸ”· TypeScript ç±»å‹æ£€æŸ¥
        working-directory: auto-rpa-app
        run: |
          echo "ğŸ” TypeScriptç±»å‹æ£€æŸ¥..."
          npx tsc --noEmit

      # Step 7: ä¸Šä¼ ä»£ç æ£€æŸ¥æŠ¥å‘Š
      - name: ğŸ“Š ä¸Šä¼ ä»£ç æ£€æŸ¥æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-report
          path: |
            auto-rpa-app/eslint-report.json
            auto-rpa-app/prettier-report.json
          retention-days: 7

  # ç¬¬äºŒä¸ªä»»åŠ¡ï¼šå•å…ƒæµ‹è¯•
  test:
    name: ğŸ§ª å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality  # ä¾èµ–ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡
    if: ${{ !inputs.skip_tests }}  # å¦‚æœæ‰‹åŠ¨è§¦å‘æ—¶é€‰æ‹©è·³è¿‡æµ‹è¯•ï¼Œåˆ™ä¸è¿è¡Œ

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ ç¼“å­˜ npm ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('auto-rpa-app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: auto-rpa-app
        run: |
          if [ -f "package-lock.json" ]; then
            echo "ğŸ”’ å°è¯•ä½¿ç”¨ npm ci (é”å®šç‰ˆæœ¬)"
            npm ci || {
              echo "âš ï¸ npm ci å¤±è´¥ï¼Œä½¿ç”¨ npm install"
              rm package-lock.json
              npm install
            }
          else
            echo "ğŸ†• ä½¿ç”¨ npm install (ç”Ÿæˆé”å®šæ–‡ä»¶)"
            npm install
          fi

      # è¿è¡ŒJestæµ‹è¯•
      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: auto-rpa-app
        run: |
          echo "ğŸ§ª è¿è¡ŒJestå•å…ƒæµ‹è¯•..."
          npm test -- --coverage --watchAll=false --passWithNoTests

      # ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
        uses: codecov/codecov-action@v3
        with:
          directory: auto-rpa-app/coverage
          flags: unittests
          name: rpa-app-coverage

  # ç¬¬ä¸‰ä¸ªä»»åŠ¡ï¼šAndroidæ„å»º
  build-android:
    name: ğŸ¤– Android æ„å»º
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    
    strategy:
      matrix:
        # æ„å»ºçŸ©é˜µ - å¯ä»¥åŒæ—¶æ„å»ºå¤šä¸ªç‰ˆæœ¬
        build-type: ${{ github.event_name == 'pull_request' && fromJSON('["debug"]') || fromJSON('["debug", "release"]') }}

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ£€æŸ¥ç³»ç»Ÿèµ„æº
      - name: ğŸ’» æ£€æŸ¥ç³»ç»Ÿèµ„æº
        run: |
          echo "ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:"
          echo "CPU: $(nproc) cores"
          echo "å†…å­˜: $(free -h | grep '^Mem:' | awk '{print $2}')"
          echo "ç£ç›˜: $(df -h / | tail -1 | awk '{print $4}') å¯ç”¨"
          echo "Javaç‰ˆæœ¬: $(java -version 2>&1 | head -1)"
          echo ""

      # è®¾ç½®Javaç¯å¢ƒï¼ˆAndroidæ„å»ºéœ€è¦ï¼‰
      - name: â˜• è®¾ç½® JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      # è®¾ç½®Android SDK
      - name: ğŸ¤– è®¾ç½® Android SDK
        uses: android-actions/setup-android@v3
        env:
          SKIP_JDK_VERSION_CHECK: true  # è·³è¿‡JDKç‰ˆæœ¬æ£€æŸ¥
        with:
          cmdline-tools-version: '11076708'  # ä½¿ç”¨æœ‰æ•ˆçš„å‚æ•°
          accept-android-sdk-licenses: true
          packages: 'platform-tools platforms;android-${{ env.ANDROID_API_LEVEL }} build-tools;33.0.0'

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ ç¼“å­˜ npm ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('auto-rpa-app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: auto-rpa-app
        run: |
          if [ -f "package-lock.json" ]; then
            echo "ğŸ”’ å°è¯•ä½¿ç”¨ npm ci (é”å®šç‰ˆæœ¬)"
            npm ci || {
              echo "âš ï¸ npm ci å¤±è´¥ï¼Œä½¿ç”¨ npm install"
              rm package-lock.json
              npm install
            }
          else
            echo "ğŸ†• ä½¿ç”¨ npm install (ç”Ÿæˆé”å®šæ–‡ä»¶)"
            npm install
          fi

      # ç¼“å­˜Gradleä¾èµ–
      - name: ğŸ“¦ ç¼“å­˜ Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            auto-rpa-app/android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('auto-rpa-app/android/gradle/wrapper/gradle-wrapper.properties') }}

      # æ„å»ºAndroidåº”ç”¨
      - name: ğŸ”¨ æ„å»º Android APK (${{ matrix.build-type }})
        working-directory: auto-rpa-app/android
        timeout-minutes: 30  # è®¾ç½®è¶…æ—¶æ—¶é—´
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»º ${{ matrix.build-type }} ç‰ˆæœ¬..."
          
          # è®¾ç½®Gradleä¼˜åŒ–å‚æ•°
          export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError"
          
          # æ£€æŸ¥gradle wrapperæƒé™
          chmod +x ./gradlew
          
          if [ "${{ matrix.build-type }}" = "release" ]; then
            ./gradlew assembleRelease \
              --no-daemon \
              --stacktrace \
              --info \
              --parallel \
              --build-cache \
              -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m" \
              -Dorg.gradle.parallel=true \
              -Dorg.gradle.configureondemand=true
          else
            ./gradlew assembleDebug \
              --no-daemon \
              --stacktrace \
              --info \
              --parallel \
              --build-cache \
              -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m" \
              -Dorg.gradle.parallel=true \
              -Dorg.gradle.configureondemand=true
          fi

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ğŸ“¤ ä¸Šä¼  APK
        uses: actions/upload-artifact@v4
        with:
          name: rpa-app-${{ matrix.build-type }}-${{ github.sha }}
          path: |
            auto-rpa-app/android/app/build/outputs/apk/**/*.apk
            auto-rpa-app/android/app/build/outputs/mapping/**/mapping.txt
          retention-days: 30

      # è·å–APKä¿¡æ¯
      - name: ğŸ“‹ APK ä¿¡æ¯
        working-directory: auto-rpa-app/android
        run: |
          echo "ğŸ“± APKæ„å»ºä¿¡æ¯ï¼š"
          find app/build/outputs/apk -name "*.apk" -exec ls -lh {} \;
          
          # å¦‚æœæ˜¯releaseç‰ˆæœ¬ï¼Œæ˜¾ç¤ºç­¾åä¿¡æ¯
          if [ "${{ matrix.build-type }}" = "release" ]; then
            echo "ğŸ” APKç­¾åä¿¡æ¯ï¼š"
            find app/build/outputs/apk -name "*.apk" -exec aapt dump badging {} \; | head -5
          fi

  # ç¬¬å››ä¸ªä»»åŠ¡ï¼šéƒ¨ç½²ï¼ˆä»…åœ¨ä¸»åˆ†æ”¯ï¼‰
  deploy:
    name: ğŸš€ éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [build-android]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/releases

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ä¸‹è½½æ„å»ºäº§ç‰©
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: rpa-app-*
          path: ./artifacts

      # åˆ›å»ºå‘å¸ƒ
      - name: ğŸ·ï¸ åˆ›å»ºå‘å¸ƒ
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/**/*.apk
          body: |
            ## ğŸ¤– RPA App å‘å¸ƒ

            ### ğŸ“± APKä¸‹è½½
            - **Debugç‰ˆæœ¬**: ç”¨äºå¼€å‘å’Œæµ‹è¯•
            - **Releaseç‰ˆæœ¬**: ç”¨äºç”Ÿäº§ç¯å¢ƒ

            ### ğŸ”„ æ›´æ–°å†…å®¹
            ${{ github.event.head_commit.message }}

            ### ğŸ“Š æ„å»ºä¿¡æ¯
            - **æäº¤**: ${{ github.sha }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false

  # ç¬¬äº”ä¸ªä»»åŠ¡ï¼šé€šçŸ¥
  notify:
    name: ğŸ“¢ æ„å»ºé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [code-quality, test, build-android]
    if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿è¡Œ

    steps:
      - name: ğŸ“Š æ„å»ºç»“æœæ€»ç»“
        run: |
          echo "## ğŸ¤– RPA App æ„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å•å…ƒæµ‹è¯•: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Androidæ„å»º: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— ç›¸å…³é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [æŸ¥çœ‹æ„å»ºæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ä¸‹è½½APK](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      # å¦‚æœæ„å»ºå¤±è´¥ï¼Œåˆ›å»ºIssue
      - name: ğŸ› åˆ›å»ºå¤±è´¥Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ æ„å»ºå¤±è´¥ - ${context.sha.substring(0, 7)}`,
              body: `
            ## ğŸš¨ æ„å»ºå¤±è´¥æŠ¥å‘Š
            
            **æäº¤**: ${context.sha}
            **åˆ†æ”¯**: ${context.ref}
            **è§¦å‘è€…**: ${context.actor}
            **æ—¶é—´**: ${new Date().toISOString()}
            
            ### ğŸ“‹ å¤±è´¥ä»»åŠ¡
            - ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}
            - å•å…ƒæµ‹è¯•: ${{ needs.test.result }}
            - Androidæ„å»º: ${{ needs.build-android.result }}
            
            ### ğŸ”— æŸ¥çœ‹è¯¦æƒ…
            [æ„å»ºæ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜ã€‚
              `,
              labels: ['bug', 'ci/cd', 'auto-created']
            }) 