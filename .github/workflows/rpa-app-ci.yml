# ğŸ¤– RPA App CI Pipeline
# ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•ï¼Œä¸åŒ…å«æ„å»º

name: ğŸ” RPA App CI

# è§¦å‘æ¡ä»¶ - åªåœ¨çœŸæ­£éœ€è¦æ—¶è§¦å‘
on:
  # åªåœ¨ PR æ—¶è§¦å‘ä»£ç æ£€æŸ¥
  pull_request:
    branches: [ main ]
    paths:
      - 'auto-rpa-app/**'
      - '.github/workflows/**'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: auto-rpa-app/package-lock.json

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: auto-rpa-app
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: ğŸ¨ ä»£ç æ ¼å¼æ£€æŸ¥
        working-directory: auto-rpa-app
        run: npm run format:check

      - name: ğŸ” ESLint æ£€æŸ¥
        working-directory: auto-rpa-app
        run: npm run lint

      - name: ğŸ”· TypeScript ç±»å‹æ£€æŸ¥
        working-directory: auto-rpa-app
        run: npx tsc --noEmit

  # å•å…ƒæµ‹è¯•
  test:
    name: ğŸ§ª å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: auto-rpa-app/package-lock.json

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: auto-rpa-app
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        working-directory: auto-rpa-app
        run: npm test -- --coverage --watchAll=false --passWithNoTests 