# ğŸ“š GitHub Actions å­¦ä¹ ç¤ºä¾‹
# è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„Actionï¼Œä¸“é—¨ç”¨äºå­¦ä¹ GitHub Actionsçš„åŸºç¡€æ¦‚å¿µ

name: ğŸ“š å­¦ä¹  GitHub Actions

# ğŸ¯ è§¦å‘æ¡ä»¶ (Triggers)
on:
  # å½“æ¨é€ä»£ç åˆ°ä»»ä½•åˆ†æ”¯æ—¶è§¦å‘
  push:
  # å½“åˆ›å»ºPull Requestæ—¶è§¦å‘  
  pull_request:
  # å®šæ—¶è§¦å‘ - æ¯å¤©æ—©ä¸Š8ç‚¹ (UTCæ—¶é—´)
  schedule:
    - cron: '0 8 * * *'
  # æ‰‹åŠ¨è§¦å‘ - å¯ä»¥åœ¨GitHubç•Œé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      greeting:
        description: 'è¾“å…¥ä¸€ä¸ªé—®å€™è¯­'
        required: true
        default: 'Hello World!'

# ğŸŒ ç¯å¢ƒå˜é‡ (Environment Variables)
env:
  GLOBAL_VAR: "è¿™æ˜¯å…¨å±€ç¯å¢ƒå˜é‡"
  PROJECT_NAME: "RPA App"

# ğŸ—ï¸ ä»»åŠ¡ (Jobs)
jobs:
  # ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼šåŸºç¡€æ“ä½œ
  basic-operations:
    name: ğŸ”° åŸºç¡€æ“ä½œå­¦ä¹ 
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒ
    
    # ğŸ“ ä»»åŠ¡çº§åˆ«çš„ç¯å¢ƒå˜é‡
    env:
      JOB_VAR: "è¿™æ˜¯ä»»åŠ¡çº§åˆ«çš„ç¯å¢ƒå˜é‡"
    
    steps:
      # Step 1: è¾“å‡ºåŸºæœ¬ä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        run: |
          echo "ğŸ‰ æ¬¢è¿å­¦ä¹  GitHub Actions!"
          echo "ğŸ“… å½“å‰æ—¶é—´: $(date)"
          echo "ğŸ–¥ï¸  è¿è¡Œç¯å¢ƒ: ${{ runner.os }}"
          echo "ğŸ·ï¸  äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          echo "ğŸ‘¤ è§¦å‘è€…: ${{ github.actor }}"
          echo "ğŸ“‚ ä»“åº“: ${{ github.repository }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ”— æäº¤: ${{ github.sha }}"

      # Step 2: ç¯å¢ƒå˜é‡æ¼”ç¤º
      - name: ğŸŒ ç¯å¢ƒå˜é‡æ¼”ç¤º
        env:
          STEP_VAR: "è¿™æ˜¯æ­¥éª¤çº§åˆ«çš„ç¯å¢ƒå˜é‡"
        run: |
          echo "ğŸŒ ç¯å¢ƒå˜é‡æ¼”ç¤º:"
          echo "- å…¨å±€å˜é‡: $GLOBAL_VAR"
          echo "- ä»»åŠ¡å˜é‡: $JOB_VAR" 
          echo "- æ­¥éª¤å˜é‡: $STEP_VAR"
          echo "- é¡¹ç›®åç§°: $PROJECT_NAME"

      # Step 3: æ¡ä»¶æ‰§è¡Œ
      - name: ğŸ¯ æ¡ä»¶æ‰§è¡Œæ¼”ç¤º
        if: github.event_name == 'push'
        run: |
          echo "âœ… è¿™ä¸ªæ­¥éª¤åªåœ¨pushäº‹ä»¶æ—¶æ‰§è¡Œ"
          echo "ğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"

      # Step 4: æ‰‹åŠ¨è¾“å…¥æ¼”ç¤º
      - name: ğŸ’¬ æ‰‹åŠ¨è¾“å…¥æ¼”ç¤º
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ‘‹ æ‰‹åŠ¨è§¦å‘çš„é—®å€™è¯­: ${{ inputs.greeting }}"

      # Step 5: åˆ›å»ºæ–‡ä»¶
      - name: ğŸ“„ åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        run: |
          echo "ğŸ“ åˆ›å»ºæµ‹è¯•æ–‡ä»¶..."
          mkdir -p test-output
          echo "Hello from GitHub Actions!" > test-output/hello.txt
          echo "æ„å»ºæ—¶é—´: $(date)" > test-output/build-info.txt
          echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> test-output/build-info.txt
          ls -la test-output/

      # Step 6: ä¸Šä¼ æ–‡ä»¶ (Artifacts)
      - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: test-files-${{ github.run_number }}
          path: test-output/
          retention-days: 5

  # ç¬¬äºŒä¸ªä»»åŠ¡ï¼šä»£ç æ“ä½œ
  code-operations:
    name: ğŸ’» ä»£ç æ“ä½œå­¦ä¹ 
    runs-on: ubuntu-latest
    needs: basic-operations  # ä¾èµ–ç¬¬ä¸€ä¸ªä»»åŠ¡å®Œæˆ
    
    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤

      # Step 2: æ˜¾ç¤ºé¡¹ç›®ç»“æ„
      - name: ğŸ“ æ˜¾ç¤ºé¡¹ç›®ç»“æ„
        run: |
          echo "ğŸ“‚ é¡¹ç›®æ ¹ç›®å½•ç»“æ„:"
          ls -la
          echo ""
          echo "ğŸ“± RPAåº”ç”¨ç›®å½•ç»“æ„:"
          if [ -d "auto-rpa-app" ]; then
            ls -la auto-rpa-app/
          else
            echo "âŒ auto-rpa-app ç›®å½•ä¸å­˜åœ¨"
          fi

      # Step 3: æ£€æŸ¥æ–‡ä»¶
      - name: ğŸ” æ£€æŸ¥é‡è¦æ–‡ä»¶
        run: |
          echo "ğŸ” æ£€æŸ¥é‡è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
          files=(
            "README.md"
            "auto-rpa-app/package.json"
            "auto-rpa-app/android/build.gradle"
            ".github/workflows"
          )
          
          for file in "${files[@]}"; do
            if [ -e "$file" ]; then
              echo "âœ… $file - å­˜åœ¨"
            else
              echo "âŒ $file - ä¸å­˜åœ¨"
            fi
          done

      # Step 4: è¯»å–package.jsonä¿¡æ¯
      - name: ğŸ“¦ è¯»å–é¡¹ç›®ä¿¡æ¯
        if: hashFiles('auto-rpa-app/package.json') != ''
        run: |
          echo "ğŸ“¦ é¡¹ç›®ä¿¡æ¯:"
          cd auto-rpa-app
          if command -v jq &> /dev/null; then
            echo "- é¡¹ç›®åç§°: $(cat package.json | jq -r '.name')"
            echo "- ç‰ˆæœ¬: $(cat package.json | jq -r '.version')"
            echo "- æè¿°: $(cat package.json | jq -r '.description')"
          else
            echo "ğŸ“„ package.json å†…å®¹:"
            head -10 package.json
          fi

  # ç¬¬ä¸‰ä¸ªä»»åŠ¡ï¼šå¤šå¹³å°æ„å»º
  multi-platform:
    name: ğŸŒ å¤šå¹³å°æ¼”ç¤º
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20]
        exclude:
          # æ’é™¤Windows + Node 20çš„ç»„åˆ
          - os: windows-latest
            node-version: 20
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: ğŸ–¥ï¸ å¹³å°ä¿¡æ¯
        run: |
          echo "ğŸ–¥ï¸  æ“ä½œç³»ç»Ÿ: ${{ matrix.os }}"
          echo "ğŸŸ¢ Node.jsç‰ˆæœ¬: ${{ matrix.node-version }}"
          echo "ğŸƒ è¿è¡Œå™¨: ${{ runner.os }}"

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: âœ… éªŒè¯å®‰è£…
        run: |
          echo "Node.jsç‰ˆæœ¬: $(node --version)"
          echo "npmç‰ˆæœ¬: $(npm --version)"

  # ç¬¬å››ä¸ªä»»åŠ¡ï¼šé”™è¯¯å¤„ç†å’Œé‡è¯•
  error-handling:
    name: ğŸ› ï¸ é”™è¯¯å¤„ç†å­¦ä¹ 
    runs-on: ubuntu-latest
    
    steps:
      # æ¼”ç¤ºå¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
      - name: âš ï¸ å¯èƒ½å¤±è´¥çš„æ­¥éª¤
        continue-on-error: true
        run: |
          echo "ğŸ² éšæœºæˆåŠŸæˆ–å¤±è´¥..."
          if [ $((RANDOM % 2)) -eq 0 ]; then
            echo "âœ… è¿™æ¬¡æˆåŠŸäº†!"
            exit 0
          else
            echo "âŒ è¿™æ¬¡å¤±è´¥äº†!"
            exit 1
          fi

      # æ€»æ˜¯æ‰§è¡Œçš„æ­¥éª¤
      - name: ğŸ”„ æ€»æ˜¯æ‰§è¡Œçš„æ¸…ç†æ­¥éª¤
        if: always()
        run: |
          echo "ğŸ§¹ æ‰§è¡Œæ¸…ç†å·¥ä½œ..."
          echo "ğŸ“Š è¿™ä¸ªæ­¥éª¤æ— è®ºå‰é¢æˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œ"

      # åªåœ¨å¤±è´¥æ—¶æ‰§è¡Œ
      - name: ğŸš¨ å¤±è´¥æ—¶çš„å¤„ç†
        if: failure()
        run: |
          echo "ğŸš¨ æ£€æµ‹åˆ°å‰é¢çš„æ­¥éª¤å¤±è´¥äº†"
          echo "ğŸ“§ è¿™é‡Œå¯ä»¥å‘é€é€šçŸ¥æˆ–æ‰§è¡Œæ¢å¤æ“ä½œ"

  # ç¬¬äº”ä¸ªä»»åŠ¡ï¼šè¾“å‡ºå’Œå…±äº«æ•°æ®
  data-sharing:
    name: ğŸ“Š æ•°æ®å…±äº«å­¦ä¹ 
    runs-on: ubuntu-latest
    outputs:
      # å®šä¹‰è¾“å‡ºå˜é‡
      build-time: ${{ steps.build-info.outputs.time }}
      random-number: ${{ steps.generate.outputs.number }}
    
    steps:
      - name: ğŸ² ç”Ÿæˆéšæœºæ•°æ®
        id: generate
        run: |
          number=$((RANDOM % 1000))
          echo "ğŸ² ç”Ÿæˆçš„éšæœºæ•°: $number"
          echo "number=$number" >> $GITHUB_OUTPUT

      - name: â° è®°å½•æ„å»ºä¿¡æ¯
        id: build-info
        run: |
          current_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "â° æ„å»ºæ—¶é—´: $current_time"
          echo "time=$current_time" >> $GITHUB_OUTPUT

      - name: ğŸ“ åˆ›å»ºæ‘˜è¦
        run: |
          echo "## ğŸ“Š æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ² éšæœºæ•°: ${{ steps.generate.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- â° æ„å»ºæ—¶é—´: ${{ steps.build-info.outputs.time }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ·ï¸ è¿è¡ŒID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

  # ç¬¬å…­ä¸ªä»»åŠ¡ï¼šä½¿ç”¨å‰é¢ä»»åŠ¡çš„è¾“å‡º
  use-outputs:
    name: ğŸ“¥ ä½¿ç”¨è¾“å‡ºæ•°æ®
    runs-on: ubuntu-latest
    needs: data-sharing
    
    steps:
      - name: ğŸ“Š æ˜¾ç¤ºå…±äº«æ•°æ®
        run: |
          echo "ğŸ“¥ ä»å‰é¢ä»»åŠ¡è·å–çš„æ•°æ®:"
          echo "- æ„å»ºæ—¶é—´: ${{ needs.data-sharing.outputs.build-time }}"
          echo "- éšæœºæ•°: ${{ needs.data-sharing.outputs.random-number }}"

      - name: ğŸ¯ åŸºäºæ•°æ®çš„æ¡ä»¶æ“ä½œ
        if: needs.data-sharing.outputs.random-number > 500
        run: |
          echo "ğŸ‰ éšæœºæ•°å¤§äº500ï¼Œæ‰§è¡Œç‰¹æ®Šæ“ä½œ!"
          echo "ğŸ² æ•°å€¼: ${{ needs.data-sharing.outputs.random-number }}" 