<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RPA è¿œç¨‹è°ƒè¯•ç•Œé¢</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 20px;
      }

      .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .status-badge.connected {
        background-color: #d4edda;
        color: #155724;
      }

      .status-badge.disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
      }

      textarea {
        width: 100%;
        height: 300px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
        resize: vertical;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        flex: 1;
        transition: background-color 0.2s;
      }

      button.primary {
        background-color: #007aff;
        color: white;
      }

      button.secondary {
        background-color: #6c757d;
        color: white;
      }

      button.danger {
        background-color: #dc3545;
        color: white;
      }

      button.warning {
        background-color: #ff9500;
        color: white;
      }

      button:hover {
        opacity: 0.9;
      }

      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .result-container {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        background-color: #f8f9fa;
        border-left: 4px solid #6c757d;
      }

      .result-success {
        border-left-color: #28a745;
      }

      .result-error {
        border-left-color: #dc3545;
      }

      .result-title {
        font-weight: bold;
        margin-bottom: 10px;
      }

      .result-content {
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 200px;
        overflow-y: auto;
      }

      .examples-container {
        margin-top: 20px;
      }

      .example-item {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 4px;
        cursor: pointer;
      }

      .example-item:hover {
        background-color: #e0e0e0;
      }

      .connection-form {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      .connection-form input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>RPA è¿œç¨‹è°ƒè¯•ç•Œé¢</h1>

      <div class="connection-form">
        <input type="text" id="serverUrl" placeholder="æœåŠ¡å™¨åœ°å€" value="http://localhost:8080" />
        <button class="primary" id="checkConnection">æ£€æŸ¥è¿æ¥</button>
        <button class="secondary" id="testXHR">æµ‹è¯•XHRè¿æ¥</button>
        <button class="primary" id="useProxy">ä½¿ç”¨ä»£ç†è¿æ¥</button>
        <button class="warning" id="healthCheck">ğŸ” å¥åº·æ£€æŸ¥</button>
      </div>

      <div id="statusBadge" class="status-badge disconnected">æœªè¿æ¥</div>

      <div class="form-group">
        <label for="scriptContent">è„šæœ¬å†…å®¹ï¼š</label>
        <textarea
          id="scriptContent"
          placeholder="// åœ¨æ­¤è¾“å…¥è¦æ‰§è¡Œçš„ JavaScript ä»£ç 
// ç¤ºä¾‹:
console.log('Hello from RPA!');
RPAServiceModule.launchSettings();
return 'è„šæœ¬æ‰§è¡Œå®Œæˆ âœ…';"
        ></textarea>

        <div class="button-group">
          <button class="primary" id="executeBtn">æ‰§è¡Œè„šæœ¬</button>
          <button class="secondary" id="clearBtn">æ¸…ç©º</button>
        </div>
      </div>

      <div id="resultContainer" class="result-container" style="display: none">
        <div class="result-title">æ‰§è¡Œç»“æœï¼š</div>
        <div id="resultContent" class="result-content"></div>
      </div>

      <div class="examples-container">
        <h3>ç¤ºä¾‹è„šæœ¬ï¼š</h3>
        <div class="example-item" data-script-key="launchSettings">æ‰“å¼€ç³»ç»Ÿè®¾ç½®</div>
        <div class="example-item" data-script-key="launchWifiSettings">æ‰“å¼€ WiFi è®¾ç½®</div>
        <div class="example-item" data-script-key="launchBluetoothSettings">æ‰“å¼€è“ç‰™è®¾ç½®</div>
        <div class="example-item" data-script-key="launchAppByPackage">æ‰“å¼€æŒ‡å®šåŒ…åçš„åº”ç”¨</div>
        <div class="example-item" data-script-key="launchBrowser">æ‰“å¼€æµè§ˆå™¨</div>
        <div class="example-item" data-script-key="launchQQ">æ‰“å¼€QQåº”ç”¨</div>
        <div class="example-item" data-script-key="launchWeChat">æ‰“å¼€å¾®ä¿¡åº”ç”¨</div>
        <div class="example-item" data-script-key="customExample">è‡ªå®šä¹‰ç¤ºä¾‹è„šæœ¬</div>
        <div class="example-item" data-script-key="multiStepExample">å¤šæ­¥éª¤æ“ä½œç¤ºä¾‹</div>
        <div class="example-item" data-script-key="helloWorld">Hello Worldæµ‹è¯•</div>
      </div>
    </div>

    <!-- å¼•å…¥è„šæœ¬é…ç½®æ–‡ä»¶ -->
    <script src="scripts-config.js"></script>

    <script>
      // ä½¿ç”¨ä»å¤–éƒ¨æ–‡ä»¶åŠ è½½çš„è„šæœ¬é…ç½®
      const scripts = window.RPAScripts;

      document.addEventListener('DOMContentLoaded', function () {
        const serverUrlInput = document.getElementById('serverUrl');
        const checkConnectionBtn = document.getElementById('checkConnection');
        const statusBadge = document.getElementById('statusBadge');
        const scriptContentTextarea = document.getElementById('scriptContent');
        const executeBtn = document.getElementById('executeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultContainer = document.getElementById('resultContainer');
        const resultContent = document.getElementById('resultContent');
        const exampleItems = document.querySelectorAll('.example-item');
        const testXHRBtn = document.getElementById('testXHR');
        const useProxyBtn = document.getElementById('useProxy');
        const healthCheckBtn = document.getElementById('healthCheck');

        // ä½¿ç”¨ä»£ç†è¿æ¥
        useProxyBtn.addEventListener('click', async function () {
          const serverUrl = serverUrlInput.value.trim();
          if (!serverUrl) {
            alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
            return;
          }

          useProxyBtn.disabled = true;
          useProxyBtn.textContent = 'æ­£åœ¨è¿æ¥...';

          // æ˜¾ç¤ºè¯¦ç»†çš„è¿æ¥ä¿¡æ¯
          statusBadge.textContent = `æ­£åœ¨é€šè¿‡ä»£ç†è¿æ¥ ${serverUrl}/status...`;
          statusBadge.className = 'status-badge disconnected';

          // æ„å»ºä»£ç†URL
          const proxyUrl = `/proxy/${serverUrl.replace(/^https?:\/\//, '')}/status`;
          console.log(`ä½¿ç”¨ä»£ç†URL: ${proxyUrl}`);

          try {
            const response = await fetch(proxyUrl);
            console.log('æ”¶åˆ°ä»£ç†å“åº”:', response.status);

            if (response.ok) {
              const data = await response.json();
              console.log('å“åº”æ•°æ®:', data);
              statusBadge.textContent = `å·²è¿æ¥ - ${data.message}`;
              statusBadge.className = 'status-badge connected';

              // ä¿å­˜ä½¿ç”¨ä»£ç†çš„çŠ¶æ€
              window.useProxyForRequests = true;
              window.targetServerUrl = serverUrl;

              resultContainer.style.display = 'block';
              resultContainer.className = 'result-container result-success';
              resultContent.textContent = `ä»£ç†è¿æ¥æˆåŠŸ!\n\nå“åº”æ•°æ®: ${JSON.stringify(
                data,
                null,
                2,
              )}\n\nç°åœ¨æ‰€æœ‰è¯·æ±‚å°†é€šè¿‡ä»£ç†å‘é€ã€‚`;
            } else {
              statusBadge.textContent = `ä»£ç†è¿æ¥å¤±è´¥ - HTTPçŠ¶æ€ç : ${response.status}`;
              statusBadge.className = 'status-badge disconnected';

              resultContainer.style.display = 'block';
              resultContainer.className = 'result-container result-error';
              resultContent.textContent = `ä»£ç†è¿æ¥å¤±è´¥: HTTP ${response.status} ${response.statusText}`;
            }
          } catch (error) {
            console.error('ä»£ç†è¿æ¥é”™è¯¯:', error);
            statusBadge.textContent = `ä»£ç†è¿æ¥é”™è¯¯: ${error.message}`;
            statusBadge.className = 'status-badge disconnected';

            resultContainer.style.display = 'block';
            resultContainer.className = 'result-container result-error';
            resultContent.textContent = `ä»£ç†è¿æ¥é”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿WebæœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚`;
          } finally {
            useProxyBtn.disabled = false;
            useProxyBtn.textContent = 'ä½¿ç”¨ä»£ç†è¿æ¥';
          }
        });

        // ä½¿ç”¨XHRæµ‹è¯•è¿æ¥
        testXHRBtn.addEventListener('click', function () {
          const serverUrl = serverUrlInput.value.trim();
          if (!serverUrl) {
            alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
            return;
          }

          testXHRBtn.disabled = true;
          testXHRBtn.textContent = 'æ­£åœ¨è¿æ¥...';

          // æ˜¾ç¤ºè¯¦ç»†çš„è¿æ¥ä¿¡æ¯
          statusBadge.textContent = `æ­£åœ¨ä½¿ç”¨XHRè¿æ¥ ${serverUrl}/status...`;
          statusBadge.className = 'status-badge disconnected';

          const xhr = new XMLHttpRequest();
          xhr.open('GET', `${serverUrl}/status`, true);
          xhr.setRequestHeader('Content-Type', 'application/json');

          xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const data = JSON.parse(xhr.responseText);
                statusBadge.textContent = `å·²è¿æ¥ - ${data.message}`;
                statusBadge.className = 'status-badge connected';

                resultContainer.style.display = 'block';
                resultContainer.className = 'result-container result-success';
                resultContent.textContent = `è¿æ¥æˆåŠŸ!\n\nå“åº”æ•°æ®: ${xhr.responseText}`;
              } catch (e) {
                statusBadge.textContent = `è§£æå“åº”å¤±è´¥`;
                statusBadge.className = 'status-badge disconnected';

                resultContainer.style.display = 'block';
                resultContainer.className = 'result-container result-error';
                resultContent.textContent = `è§£æå“åº”å¤±è´¥: ${e.message}\n\nåŸå§‹å“åº”: ${xhr.responseText}`;
              }
            } else {
              statusBadge.textContent = `è¿æ¥å¤±è´¥ - HTTPçŠ¶æ€ç : ${xhr.status}`;
              statusBadge.className = 'status-badge disconnected';

              resultContainer.style.display = 'block';
              resultContainer.className = 'result-container result-error';
              resultContent.textContent = `HTTPé”™è¯¯: ${xhr.status} ${xhr.statusText}\n\nå“åº”: ${xhr.responseText}`;
            }
            testXHRBtn.disabled = false;
            testXHRBtn.textContent = 'æµ‹è¯•XHRè¿æ¥';
          };

          xhr.onerror = function () {
            statusBadge.textContent = `è¿æ¥é”™è¯¯: ç½‘ç»œé”™è¯¯`;
            statusBadge.className = 'status-badge disconnected';

            resultContainer.style.display = 'block';
            resultContainer.className = 'result-container result-error';
            resultContent.textContent = `è¿æ¥å¤±è´¥æ’æŸ¥æ­¥éª¤:
1. ç¡®ä¿RPAåº”ç”¨å·²å¯åŠ¨å¹¶ä¸”HTTPæœåŠ¡å™¨å¤„äºè¿è¡ŒçŠ¶æ€
2. ç¡®ä¿è®¾å¤‡å’Œç”µè„‘åœ¨åŒä¸€ç½‘ç»œä¸­
3. æ£€æŸ¥è¾“å…¥çš„IPåœ°å€å’Œç«¯å£æ˜¯å¦æ­£ç¡®
4. å°è¯•ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·å¦‚curlæµ‹è¯•è¿æ¥: curl ${serverUrl}/status
5. æ£€æŸ¥è®¾å¤‡é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†ç«¯å£è®¿é—®
6. å¦‚æœä½¿ç”¨çš„æ˜¯æ¨¡æ‹Ÿå™¨ï¼Œå°è¯•ä½¿ç”¨10.0.2.2æ›¿ä»£localhost

é”™è¯¯è¯¦æƒ…: ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨`;

            testXHRBtn.disabled = false;
            testXHRBtn.textContent = 'æµ‹è¯•XHRè¿æ¥';
          };

          xhr.timeout = 10000; // 10ç§’è¶…æ—¶
          xhr.ontimeout = function () {
            statusBadge.textContent = `è¿æ¥è¶…æ—¶`;
            statusBadge.className = 'status-badge disconnected';

            resultContainer.style.display = 'block';
            resultContainer.className = 'result-container result-error';
            resultContent.textContent = `è¿æ¥è¶…æ—¶ - è¯·æ£€æŸ¥è®¾å¤‡IPå’Œç«¯å£æ˜¯å¦æ­£ç¡®`;

            testXHRBtn.disabled = false;
            testXHRBtn.textContent = 'æµ‹è¯•XHRè¿æ¥';
          };

          xhr.send();
        });

        // å¥åº·æ£€æŸ¥åŠŸèƒ½
        healthCheckBtn.addEventListener('click', async function () {
          const serverUrl = serverUrlInput.value.trim();
          if (!serverUrl) {
            alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
            return;
          }

          healthCheckBtn.disabled = true;
          healthCheckBtn.textContent = 'ğŸ” æ£€æŸ¥ä¸­...';

          statusBadge.textContent = `æ­£åœ¨è¿›è¡Œå¥åº·æ£€æŸ¥...`;
          statusBadge.className = 'status-badge disconnected';

          try {
            // æ£€æŸ¥ /health ç«¯ç‚¹
            const healthUrl = window.useProxyForRequests
              ? `/proxy/${serverUrl.replace(/^https?:\/\//, '')}/health`
              : `${serverUrl}/health`;

            const healthResponse = await fetch(healthUrl);

            if (healthResponse.ok) {
              const healthData = await healthResponse.json();

              // åŒæ—¶æ£€æŸ¥ /status ç«¯ç‚¹
              const statusUrl = window.useProxyForRequests
                ? `/proxy/${serverUrl.replace(/^https?:\/\//, '')}/status`
                : `${serverUrl}/status`;

              const statusResponse = await fetch(statusUrl);
              const statusData = statusResponse.ok ? await statusResponse.json() : null;

              statusBadge.textContent = `å¥åº·æ£€æŸ¥é€šè¿‡ âœ…`;
              statusBadge.className = 'status-badge connected';

              resultContainer.style.display = 'block';
              resultContainer.className = 'result-container result-success';
              resultContent.textContent = `ğŸ” æœåŠ¡å™¨å¥åº·æ£€æŸ¥æŠ¥å‘Š:

âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹: æ­£å¸¸
   å“åº”æ—¶é—´: ${Date.now()}ms
   çŠ¶æ€: ${healthData.status}
   æ¶ˆæ¯: ${healthData.message}

${
  statusData
    ? `âœ… çŠ¶æ€ç«¯ç‚¹: æ­£å¸¸
   è¿è¡Œæ—¶é—´: ${statusData.uptime ? new Date(statusData.uptime).toLocaleString() : 'æœªçŸ¥'}
   é‡è¿æ¬¡æ•°: ${statusData.reconnectAttempts || 0}
   ç«¯å£: ${statusData.serverPort}`
    : 'âš ï¸ çŠ¶æ€ç«¯ç‚¹: æ— å“åº”'
}

ğŸ¯ å»ºè®®: æœåŠ¡å™¨è¿è¡Œæ­£å¸¸ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚`;
            } else {
              throw new Error(`å¥åº·æ£€æŸ¥å¤±è´¥: HTTP ${healthResponse.status}`);
            }
          } catch (error) {
            console.error('å¥åº·æ£€æŸ¥é”™è¯¯:', error);
            statusBadge.textContent = `å¥åº·æ£€æŸ¥å¤±è´¥ âŒ`;
            statusBadge.className = 'status-badge disconnected';

            resultContainer.style.display = 'block';
            resultContainer.className = 'result-container result-error';
            resultContent.textContent = `âŒ æœåŠ¡å™¨å¥åº·æ£€æŸ¥å¤±è´¥:

é”™è¯¯ä¿¡æ¯: ${error.message}

ğŸ”§ æ•…éšœæ’é™¤å»ºè®®:
1. æ£€æŸ¥RPAåº”ç”¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
2. ç¡®è®¤HTTPæœåŠ¡å™¨å·²å¯åŠ¨
3. éªŒè¯ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
4. å°è¯•é‡å¯HTTPæœåŠ¡å™¨
5. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

ğŸ’¡ æç¤º: å¯ä»¥åœ¨RPAåº”ç”¨ä¸­ç‚¹å‡»"ğŸ”„ é‡å¯ HTTP æœåŠ¡å™¨"æŒ‰é’®æ¥è§£å†³è¿æ¥é—®é¢˜ã€‚`;
          } finally {
            healthCheckBtn.disabled = false;
            healthCheckBtn.textContent = 'ğŸ” å¥åº·æ£€æŸ¥';
          }
        });

        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        checkConnectionBtn.addEventListener('click', async function () {
          const serverUrl = serverUrlInput.value.trim();
          if (!serverUrl) {
            alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
            return;
          }

          try {
            checkConnectionBtn.disabled = true;
            checkConnectionBtn.textContent = 'æ­£åœ¨è¿æ¥...';

            // æ˜¾ç¤ºè¯¦ç»†çš„è¿æ¥ä¿¡æ¯
            statusBadge.textContent = `æ­£åœ¨è¿æ¥ ${serverUrl}/status...`;
            statusBadge.className = 'status-badge disconnected';

            console.log(`å°è¯•è¿æ¥: ${serverUrl}/status`);

            const response = await fetch(`${serverUrl}/status`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
              // æ·»åŠ è¶…æ—¶è®¾ç½®
              signal: AbortSignal.timeout(10000), // 10ç§’è¶…æ—¶
            });

            console.log('æ”¶åˆ°å“åº”:', response.status);

            if (response.ok) {
              const data = await response.json();
              console.log('å“åº”æ•°æ®:', data);
              statusBadge.textContent = `å·²è¿æ¥ - ${data.message}`;
              statusBadge.className = 'status-badge connected';
            } else {
              statusBadge.textContent = `è¿æ¥å¤±è´¥ - HTTPçŠ¶æ€ç : ${response.status}`;
              statusBadge.className = 'status-badge disconnected';
            }
          } catch (error) {
            console.error('è¿æ¥é”™è¯¯:', error);

            let errorMessage = error.message;

            // æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
            if (error.name === 'AbortError') {
              errorMessage = 'è¿æ¥è¶…æ—¶ - è¯·æ£€æŸ¥è®¾å¤‡IPå’Œç«¯å£æ˜¯å¦æ­£ç¡®';
            } else if (error.message.includes('Network')) {
              errorMessage = 'ç½‘ç»œé”™è¯¯ - è¯·æ£€æŸ¥è®¾å¤‡å’Œç”µè„‘æ˜¯å¦åœ¨åŒä¸€ç½‘ç»œ';
            } else if (error.message.includes('CORS')) {
              errorMessage = 'CORSé”™è¯¯ - è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢';
            }

            statusBadge.textContent = `è¿æ¥é”™è¯¯: ${errorMessage}`;
            statusBadge.className = 'status-badge disconnected';

            // æ˜¾ç¤ºæ•…éšœæ’é™¤æç¤º
            resultContainer.style.display = 'block';
            resultContainer.className = 'result-container result-error';
            resultContent.textContent = `è¿æ¥å¤±è´¥æ’æŸ¥æ­¥éª¤:
1. ç¡®ä¿RPAåº”ç”¨å·²å¯åŠ¨å¹¶ä¸”HTTPæœåŠ¡å™¨å¤„äºè¿è¡ŒçŠ¶æ€
2. ç¡®ä¿è®¾å¤‡å’Œç”µè„‘åœ¨åŒä¸€ç½‘ç»œä¸­
3. æ£€æŸ¥è¾“å…¥çš„IPåœ°å€å’Œç«¯å£æ˜¯å¦æ­£ç¡®
4. å°è¯•pingè®¾å¤‡IPåœ°å€æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
5. æ£€æŸ¥è®¾å¤‡é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†ç«¯å£è®¿é—®
6. å¦‚æœä½¿ç”¨çš„æ˜¯æ¨¡æ‹Ÿå™¨ï¼Œå°è¯•ä½¿ç”¨10.0.2.2æ›¿ä»£localhost

é”™è¯¯è¯¦æƒ…: ${error.toString()}`;
          } finally {
            checkConnectionBtn.disabled = false;
            checkConnectionBtn.textContent = 'æ£€æŸ¥è¿æ¥';
          }
        });

        // æ‰§è¡Œè„šæœ¬
        executeBtn.addEventListener('click', async function () {
          const serverUrl = serverUrlInput.value.trim();
          let script = scriptContentTextarea.value.trim();

          // å¦‚æœè¾“å…¥çš„æ˜¯è„šæœ¬åç§°ï¼Œåˆ™ä½¿ç”¨å¯¹åº”çš„è„šæœ¬
          const scriptNames = Object.keys(scripts);
          if (scriptNames.some(name => script.toLowerCase() === name.toLowerCase())) {
            script = scripts[script].script;
          }

          if (!serverUrl) {
            alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
            return;
          }

          if (!script) {
            alert('è¯·è¾“å…¥è„šæœ¬å†…å®¹');
            return;
          }

          try {
            executeBtn.disabled = true;
            executeBtn.textContent = 'æ‰§è¡Œä¸­...';

            let url;
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ä»£ç†
            if (window.useProxyForRequests) {
              url = `/proxy/${serverUrl.replace(/^https?:\/\//, '')}/execute-script`;
              console.log('ä½¿ç”¨ä»£ç†æ‰§è¡Œè„šæœ¬:', url);
            } else {
              url = `${serverUrl}/execute-script`;
            }

            // åœ¨å‘é€å‰æ£€æŸ¥è„šæœ¬å†…å®¹çš„ç¼–ç 
            console.log('å‡†å¤‡å‘é€çš„è„šæœ¬å†…å®¹:', script);
            console.log('è„šæœ¬é•¿åº¦:', script.length);
            console.log('åŒ…å«ä¸­æ–‡å­—ç¬¦:', /[\u4e00-\u9fff]/.test(script));

            // åˆ›å»ºè¯·æ±‚ä½“
            const requestBody = JSON.stringify({ script });
            console.log('è¯·æ±‚ä½“:', requestBody);
            console.log('è¯·æ±‚ä½“é•¿åº¦:', requestBody.length);

            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json; charset=utf-8',
              },
              body: requestBody,
            });

            let data = await response.json();

            // æš‚æ—¶ç§»é™¤Base64è§£ç é€»è¾‘ï¼Œç›´æ¥å¤„ç†å“åº”
            console.log('æ¥æ”¶åˆ°åŸå§‹å“åº”æ•°æ®:', data);

            resultContainer.style.display = 'block';

            console.log('æœ€ç»ˆæ‰§è¡Œç»“æœæ•°æ®:', data);

            if (data.success) {
              resultContainer.className = 'result-container result-success';
              // æ›´å¥½åœ°æ ¼å¼åŒ–ç»“æœæ˜¾ç¤º
              let resultText = '';
              if (typeof data.result === 'string') {
                resultText = data.result;
              } else if (data.result !== undefined) {
                resultText = JSON.stringify(data.result, null, 2);
              } else {
                resultText = 'è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼ˆæ— è¿”å›å€¼ï¼‰';
              }
              resultContent.textContent = `æ‰§è¡ŒæˆåŠŸ:\n${resultText}`;
            } else {
              resultContainer.className = 'result-container result-error';
              // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
              let errorText = `æ‰§è¡Œå¤±è´¥:\né”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
              if (data.errorType) {
                errorText += `\né”™è¯¯ç±»å‹: ${data.errorType}`;
              }
              if (data.suggestion) {
                errorText += `\nå»ºè®®: ${data.suggestion}`;
              }
              if (data.stack) {
                errorText += `\n\nå †æ ˆä¿¡æ¯:\n${data.stack}`;
              }
              resultContent.textContent = errorText;
            }
          } catch (error) {
            resultContainer.style.display = 'block';
            resultContainer.className = 'result-container result-error';
            resultContent.textContent = `è¯·æ±‚é”™è¯¯: ${error.message}`;

            // æç¤ºç”¨æˆ·å°è¯•ä½¿ç”¨ä»£ç†
            if (!window.useProxyForRequests) {
              resultContent.textContent +=
                '\n\næç¤º: è¯·å°è¯•ç‚¹å‡»"ä½¿ç”¨ä»£ç†è¿æ¥"æŒ‰é’®ï¼Œé€šè¿‡ä»£ç†å‘é€è¯·æ±‚ã€‚';
            }
          } finally {
            executeBtn.disabled = false;
            executeBtn.textContent = 'æ‰§è¡Œè„šæœ¬';
          }
        });

        // æ¸…ç©ºè„šæœ¬
        clearBtn.addEventListener('click', function () {
          scriptContentTextarea.value = '';
          resultContainer.style.display = 'none';
        });

        // ä¿®æ”¹ç¤ºä¾‹è„šæœ¬åŠ è½½æ–¹å¼ - é€šè¿‡data-script-keyè·å–è„šæœ¬
        exampleItems.forEach(item => {
          item.addEventListener('click', function () {
            const scriptKey = this.getAttribute('data-script-key');
            if (scriptKey && scripts[scriptKey]) {
              scriptContentTextarea.value = scripts[scriptKey].script;

              // æ˜¾ç¤ºè„šæœ¬æè¿°ä¿¡æ¯
              console.log(`åŠ è½½è„šæœ¬: ${scripts[scriptKey].name}`);
              console.log(`æè¿°: ${scripts[scriptKey].description}`);

              // å¯é€‰ï¼šåœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºè„šæœ¬ä¿¡æ¯
              if (resultContainer) {
                resultContainer.style.display = 'block';
                resultContainer.className = 'result-container';
                resultContent.textContent = `å·²åŠ è½½è„šæœ¬: ${scripts[scriptKey].name}\næè¿°: ${scripts[scriptKey].description}`;
              }
            } else {
              console.warn('æœªæ‰¾åˆ°è„šæœ¬:', scriptKey);
              alert(`æœªæ‰¾åˆ°è„šæœ¬: ${scriptKey}`);
            }
          });
        });

        // æ·»åŠ å¿«æ·æ‰§è¡ŒåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
        // ä¸ºç¤ºä¾‹è„šæœ¬æ·»åŠ åŒå‡»ç›´æ¥æ‰§è¡ŒåŠŸèƒ½
        exampleItems.forEach(item => {
          item.addEventListener('dblclick', function () {
            const scriptKey = this.getAttribute('data-script-key');
            if (scriptKey && scripts[scriptKey]) {
              scriptContentTextarea.value = scripts[scriptKey].script;
              // åŒå‡»æ—¶è‡ªåŠ¨æ‰§è¡Œè„šæœ¬
              setTimeout(() => {
                executeBtn.click();
              }, 100);
            }
          });
        });
      });
    </script>
  </body>
</html>
